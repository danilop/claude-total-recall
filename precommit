#!/usr/bin/env bash
# Pre-commit script: checks and fixes code quality, then runs tests
set -e

echo "=== Running pre-commit checks ==="
echo

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
FAILED=0

# 1. Ruff: Format and lint
echo -e "${YELLOW}[1/4] Ruff: Formatting...${NC}"
uv run ruff format src tests || { echo -e "${RED}Ruff format failed${NC}"; FAILED=1; }

echo -e "${YELLOW}[2/4] Ruff: Linting (with auto-fix)...${NC}"
uv run ruff check --fix src tests || { echo -e "${RED}Ruff lint failed${NC}"; FAILED=1; }

# 2. Type checking with ty
echo -e "${YELLOW}[3/4] Ty: Type checking...${NC}"
uv run ty check src || { echo -e "${YELLOW}Ty found issues (non-blocking)${NC}"; }

# 3. Vulture: Dead code detection
echo -e "${YELLOW}[4/4] Vulture: Dead code detection...${NC}"
uv run vulture src --min-confidence 80 || { echo -e "${YELLOW}Vulture found potential dead code (non-blocking)${NC}"; }

echo

# 4. Run tests
echo -e "${YELLOW}[5/5] Pytest: Running tests...${NC}"
uv run pytest tests/ -v --tb=short || { echo -e "${RED}Tests failed${NC}"; FAILED=1; }

echo

# Summary
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}=== All checks passed ===${NC}"
    exit 0
else
    echo -e "${RED}=== Some checks failed ===${NC}"
    exit 1
fi
